#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <signal.h>

extern "C" {
#include "ws2811/board_info.h"
#include "ws2811/clk.h"
#include "ws2811/gpio.h"
#include "ws2811/pwm.h"
#include "ws2811/ws2811.h"
}

#include <iostream>

#define NLEDS 400

int coordinates[400][2] = { {127,127}, {121,117}, {133,117}, {139,127}, {133,137}, {121,137}, {116,127}, {116,107}, {127,107}, {139,107}, {144,117}, {150,127}, {144,137}, {138,147}, {127,147}, {115,147}, {110,137}, {104,127}, {110,117}, {110,97}, {121,97}, {133,97}, {144,97}, {150,107}, {156,117}, {162,127}, {156,137}, {150,147}, {144,157}, {133,157}, {121,157}, {110,157}, {104,147}, {98,137}, {93,127}, {98,117}, {104,107}, {104,87}, {116,87}, {127,87}, {139,87}, {150,87}, {156,97}, {162,107}, {167,117}, {173,127}, {167,137}, {161,147}, {156,157}, {150,167}, {138,167}, {127,167}, {115,167}, {104,167}, {98,157}, {92,147}, {87,137}, {81,127}, {87,117}, {93,107}, {98,97}, {98,77}, {110,77}, {121,77}, {133,77}, {144,77}, {156,77}, {162,87}, {167,97}, {173,107}, {179,117}, {185,127}, {179,137}, {173,147}, {167,157}, {161,167}, {156,177}, {144,177}, {133,177}, {121,177}, {110,177}, {98,177}, {92,167}, {87,157}, {81,147}, {75,137}, {70,127}, {75,117}, {81,107}, {87,97}, {93,87}, {93,67}, {104,67}, {116,67}, {127,67}, {139,67}, {150,67}, {162,67}, {167,77}, {173,87}, {179,97}, {185,107}, {190,117}, {196,127}, {190,137}, {184,147}, {179,157}, {173,167}, {167,177}, {161,187}, {150,187}, {138,187}, {127,187}, {115,187}, {104,187}, {92,187}, {87,177}, {81,167}, {75,157}, {69,147}, {64,137}, {58,127}, {64,117}, {70,107}, {75,97}, {81,87}, {87,77}, {87,57}, {98,57}, {110,57}, {121,57}, {133,57}, {144,57}, {156,57}, {167,57}, {173,67}, {179,77}, {185,87}, {190,97}, {196,107}, {202,117}, {208,127}, {202,137}, {196,147}, {190,157}, {184,167}, {179,177}, {173,187}, {167,197}, {156,197}, {144,197}, {133,197}, {121,197}, {110,197}, {98,197}, {87,197}, {81,187}, {75,177}, {69,167}, {64,157}, {58,147}, {52,137}, {47,127}, {52,117}, {58,107}, {64,97}, {70,87}, {75,77}, {81,67}, {81,47}, {93,47}, {104,47}, {116,47}, {127,47}, {139,47}, {150,47}, {162,47}, {173,47}, {179,57}, {185,67}, {190,77}, {196,87}, {202,97}, {208,107}, {213,117}, {219,127}, {213,137}, {207,147}, {202,157}, {196,167}, {190,177}, {184,187}, {179,197}, {173,207}, {161,207}, {150,207}, {138,207}, {127,207}, {115,207}, {104,207}, {92,207}, {81,207}, {75,197}, {69,187}, {64,177}, {58,167}, {52,157}, {46,147}, {41,137}, {35,127}, {41,117}, {47,107}, {52,97}, {58,87}, {64,77}, {70,67}, {75,57}, {75,37}, {87,37}, {98,37}, {110,37}, {121,37}, {133,37}, {144,37}, {156,37}, {167,37}, {179,37}, {185,47}, {190,57}, {196,67}, {202,77}, {208,87}, {213,97}, {219,107}, {225,117}, {231,127}, {225,137}, {219,147}, {213,157}, {207,167}, {202,177}, {196,187}, {190,197}, {184,207}, {179,217}, {167,217}, {156,217}, {144,217}, {133,217}, {121,217}, {110,217}, {98,217}, {87,217}, {75,217}, {69,207}, {64,197}, {58,187}, {52,177}, {46,167}, {41,157}, {35,147}, {29,137}, {24,127}, {29,117}, {35,107}, {41,97}, {47,87}, {52,77}, {58,67}, {64,57}, {70,47}, {70,27}, {81,27}, {93,27}, {104,27}, {116,27}, {127,27}, {139,27}, {150,27}, {162,27}, {173,27}, {185,27}, {190,37}, {196,47}, {202,57}, {208,67}, {213,77}, {219,87}, {225,97}, {231,107}, {236,117}, {242,127}, {236,137}, {230,147}, {225,157}, {219,167}, {213,177}, {207,187}, {202,197}, {196,207}, {190,217}, {184,227}, {173,227}, {161,227}, {150,227}, {138,227}, {127,227}, {115,227}, {104,227}, {92,227}, {81,227}, {69,227}, {64,217}, {58,207}, {52,197}, {46,187}, {41,177}, {35,167}, {29,157}, {23,147}, {18,137}, {12,127}, {18,117}, {24,107}, {29,97}, {35,87}, {41,77}, {47,67}, {52,57}, {58,47}, {64,37}, {64,17}, {75,17}, {87,17}, {98,17}, {110,17}, {121,17}, {133,17}, {144,17}, {156,17}, {167,17}, {179,17}, {190,17}, {196,27}, {202,37}, {208,47}, {213,57}, {219,67}, {225,77}, {231,87}, {236,97}, {242,107}, {248,117}, {254,127}, {248,137}, {242,147}, {236,157}, {230,167}, {225,177}, {219,187}, {213,197}, {207,207}, {202,217}, {196,227}, {190,237}, {179,237}, {167,237}, {156,237}, {144,237}, {133,237}, {121,237}, {110,237}, {98,237}, {87,237}, {75,237}, {64,237}, {58,227}, {52,217}, {46,207}, {41,197}, {35,187}, {29,177}, {23,167}, {18,157}, {12,147}, {6,137}, {1,127}, {6,117}, {12,107}, {18,97}, {24,87}, {29,77}, {35,67}, {41,57}, {47,47}, {52,37}, {58,27} };

int neighbors[400][6] = { {3,4,5,6,1,2}, {2,0,6,18,7,8}, {10,3,0,1,8,9}, {11,12,4,0,2,10}, {12,13,14,5,0,3}, {4,14,15,16,6,0}, {0,5,16,17,18,1}, {8,1,18,36,19,20}, {9,2,1,7,20,21}, {23,10,2,8,21,22}, {24,11,3,2,9,23}, {25,26,12,3,10,24}, {26,27,13,4,3,11}, {27,28,29,14,4,12}, {13,29,30,15,5,4}, {14,30,31,32,16,5}, {5,15,32,33,17,6}, {6,16,33,34,35,18}, {1,6,17,35,36,7}, {20,7,36,60,37,38}, {21,8,7,19,38,39}, {22,9,8,20,39,40}, {42,23,9,21,40,41}, {43,24,10,9,22,42}, {44,25,11,10,23,43}, {45,46,26,11,24,44}, {46,47,27,12,11,25}, {47,48,28,13,12,26}, {48,49,50,29,13,27}, {28,50,51,30,14,13}, {29,51,52,31,15,14}, {30,52,53,54,32,15}, {15,31,54,55,33,16}, {16,32,55,56,34,17}, {17,33,56,57,58,35}, {18,17,34,58,59,36}, {7,18,35,59,60,19}, {38,19,60,90,61,62}, {39,20,19,37,62,63}, {40,21,20,38,63,64}, {41,22,21,39,64,65}, {67,42,22,40,65,66}, {68,43,23,22,41,67}, {69,44,24,23,42,68}, {70,45,25,24,43,69}, {71,72,46,25,44,70}, {72,73,47,26,25,45}, {73,74,48,27,26,46}, {74,75,49,28,27,47}, {75,76,77,50,28,48}, {49,77,78,51,29,28}, {50,78,79,52,30,29}, {51,79,80,53,31,30}, {52,80,81,82,54,31}, {31,53,82,83,55,32}, {32,54,83,84,56,33}, {33,55,84,85,57,34}, {34,56,85,86,87,58}, {35,34,57,87,88,59}, {36,35,58,88,89,60}, {19,36,59,89,90,37}, {62,37,90,126,91,92}, {63,38,37,61,92,93}, {64,39,38,62,93,94}, {65,40,39,63,94,95}, {66,41,40,64,95,96}, {98,67,41,65,96,97}, {99,68,42,41,66,98}, {100,69,43,42,67,99}, {101,70,44,43,68,100}, {102,71,45,44,69,101}, {103,104,72,45,70,102}, {104,105,73,46,45,71}, {105,106,74,47,46,72}, {106,107,75,48,47,73}, {107,108,76,49,48,74}, {108,109,110,77,49,75}, {76,110,111,78,50,49}, {77,111,112,79,51,50}, {78,112,113,80,52,51}, {79,113,114,81,53,52}, {80,114,115,116,82,53}, {53,81,116,117,83,54}, {54,82,117,118,84,55}, {55,83,118,119,85,56}, {56,84,119,120,86,57}, {57,85,120,121,122,87}, {58,57,86,122,123,88}, {59,58,87,123,124,89}, {60,59,88,124,125,90}, {37,60,89,125,126,61}, {92,61,126,168,127,128}, {93,62,61,91,128,129}, {94,63,62,92,129,130}, {95,64,63,93,130,131}, {96,65,64,94,131,132}, {97,66,65,95,132,133}, {135,98,66,96,133,134}, {136,99,67,66,97,135}, {137,100,68,67,98,136}, {138,101,69,68,99,137}, {139,102,70,69,100,138}, {140,103,71,70,101,139}, {141,142,104,71,102,140}, {142,143,105,72,71,103}, {143,144,106,73,72,104}, {144,145,107,74,73,105}, {145,146,108,75,74,106}, {146,147,109,76,75,107}, {147,148,149,110,76,108}, {109,149,150,111,77,76}, {110,150,151,112,78,77}, {111,151,152,113,79,78}, {112,152,153,114,80,79}, {113,153,154,115,81,80}, {114,154,155,156,116,81}, {81,115,156,157,117,82}, {82,116,157,158,118,83}, {83,117,158,159,119,84}, {84,118,159,160,120,85}, {85,119,160,161,121,86}, {86,120,161,162,163,122}, {87,86,121,163,164,123}, {88,87,122,164,165,124}, {89,88,123,165,166,125}, {90,89,124,166,167,126}, {61,90,125,167,168,91}, {128,91,168,216,169,170}, {129,92,91,127,170,171}, {130,93,92,128,171,172}, {131,94,93,129,172,173}, {132,95,94,130,173,174}, {133,96,95,131,174,175}, {134,97,96,132,175,176}, {178,135,97,133,176,177}, {179,136,98,97,134,178}, {180,137,99,98,135,179}, {181,138,100,99,136,180}, {182,139,101,100,137,181}, {183,140,102,101,138,182}, {184,141,103,102,139,183}, {185,186,142,103,140,184}, {186,187,143,104,103,141}, {187,188,144,105,104,142}, {188,189,145,106,105,143}, {189,190,146,107,106,144}, {190,191,147,108,107,145}, {191,192,148,109,108,146}, {192,193,194,149,109,147}, {148,194,195,150,110,109}, {149,195,196,151,111,110}, {150,196,197,152,112,111}, {151,197,198,153,113,112}, {152,198,199,154,114,113}, {153,199,200,155,115,114}, {154,200,201,202,156,115}, {115,155,202,203,157,116}, {116,156,203,204,158,117}, {117,157,204,205,159,118}, {118,158,205,206,160,119}, {119,159,206,207,161,120}, {120,160,207,208,162,121}, {121,161,208,209,210,163}, {122,121,162,210,211,164}, {123,122,163,211,212,165}, {124,123,164,212,213,166}, {125,124,165,213,214,167}, {126,125,166,214,215,168}, {91,126,167,215,216,127}, {170,127,216,270,217,218}, {171,128,127,169,218,219}, {172,129,128,170,219,220}, {173,130,129,171,220,221}, {174,131,130,172,221,222}, {175,132,131,173,222,223}, {176,133,132,174,223,224}, {177,134,133,175,224,225}, {227,178,134,176,225,226}, {228,179,135,134,177,227}, {229,180,136,135,178,228}, {230,181,137,136,179,229}, {231,182,138,137,180,230}, {232,183,139,138,181,231}, {233,184,140,139,182,232}, {234,185,141,140,183,233}, {235,236,186,141,184,234}, {236,237,187,142,141,185}, {237,238,188,143,142,186}, {238,239,189,144,143,187}, {239,240,190,145,144,188}, {240,241,191,146,145,189}, {241,242,192,147,146,190}, {242,243,193,148,147,191}, {243,244,245,194,148,192}, {193,245,246,195,149,148}, {194,246,247,196,150,149}, {195,247,248,197,151,150}, {196,248,249,198,152,151}, {197,249,250,199,153,152}, {198,250,251,200,154,153}, {199,251,252,201,155,154}, {200,252,253,254,202,155}, {155,201,254,255,203,156}, {156,202,255,256,204,157}, {157,203,256,257,205,158}, {158,204,257,258,206,159}, {159,205,258,259,207,160}, {160,206,259,260,208,161}, {161,207,260,261,209,162}, {162,208,261,262,263,210}, {163,162,209,263,264,211}, {164,163,210,264,265,212}, {165,164,211,265,266,213}, {166,165,212,266,267,214}, {167,166,213,267,268,215}, {168,167,214,268,269,216}, {127,168,215,269,270,169}, {218,169,270,330,271,272}, {219,170,169,217,272,273}, {220,171,170,218,273,274}, {221,172,171,219,274,275}, {222,173,172,220,275,276}, {223,174,173,221,276,277}, {224,175,174,222,277,278}, {225,176,175,223,278,279}, {226,177,176,224,279,280}, {282,227,177,225,280,281}, {283,228,178,177,226,282}, {284,229,179,178,227,283}, {285,230,180,179,228,284}, {286,231,181,180,229,285}, {287,232,182,181,230,286}, {288,233,183,182,231,287}, {289,234,184,183,232,288}, {290,235,185,184,233,289}, {291,292,236,185,234,290}, {292,293,237,186,185,235}, {293,294,238,187,186,236}, {294,295,239,188,187,237}, {295,296,240,189,188,238}, {296,297,241,190,189,239}, {297,298,242,191,190,240}, {298,299,243,192,191,241}, {299,300,244,193,192,242}, {300,301,302,245,193,243}, {244,302,303,246,194,193}, {245,303,304,247,195,194}, {246,304,305,248,196,195}, {247,305,306,249,197,196}, {248,306,307,250,198,197}, {249,307,308,251,199,198}, {250,308,309,252,200,199}, {251,309,310,253,201,200}, {252,310,311,312,254,201}, {201,253,312,313,255,202}, {202,254,313,314,256,203}, {203,255,314,315,257,204}, {204,256,315,316,258,205}, {205,257,316,317,259,206}, {206,258,317,318,260,207}, {207,259,318,319,261,208}, {208,260,319,320,262,209}, {209,261,320,321,322,263}, {210,209,262,322,323,264}, {211,210,263,323,324,265}, {212,211,264,324,325,266}, {213,212,265,325,326,267}, {214,213,266,326,327,268}, {215,214,267,327,328,269}, {216,215,268,328,329,270}, {169,216,269,329,330,217}, {272,217,330,396,331,332}, {273,218,217,271,332,333}, {274,219,218,272,333,334}, {275,220,219,273,334,335}, {276,221,220,274,335,336}, {277,222,221,275,336,337}, {278,223,222,276,337,338}, {279,224,223,277,338,339}, {280,225,224,278,339,340}, {281,226,225,279,340,341}, {343,282,226,280,341,342}, {344,283,227,226,281,343}, {345,284,228,227,282,344}, {346,285,229,228,283,345}, {347,286,230,229,284,346}, {348,287,231,230,285,347}, {349,288,232,231,286,348}, {350,289,233,232,287,349}, {351,290,234,233,288,350}, {352,291,235,234,289,351}, {353,354,292,235,290,352}, {354,355,293,236,235,291}, {355,356,294,237,236,292}, {356,357,295,238,237,293}, {357,358,296,239,238,294}, {358,359,297,240,239,295}, {359,360,298,241,240,296}, {360,361,299,242,241,297}, {361,362,300,243,242,298}, {362,363,301,244,243,299}, {363,364,365,302,244,300}, {301,365,366,303,245,244}, {302,366,367,304,246,245}, {303,367,368,305,247,246}, {304,368,369,306,248,247}, {305,369,370,307,249,248}, {306,370,371,308,250,249}, {307,371,372,309,251,250}, {308,372,373,310,252,251}, {309,373,374,311,253,252}, {310,374,375,376,312,253}, {253,311,376,377,313,254}, {254,312,377,378,314,255}, {255,313,378,379,315,256}, {256,314,379,380,316,257}, {257,315,380,381,317,258}, {258,316,381,382,318,259}, {259,317,382,383,319,260}, {260,318,383,384,320,261}, {261,319,384,385,321,262}, {262,320,385,386,387,322}, {263,262,321,387,388,323}, {264,263,322,388,389,324}, {265,264,323,389,390,325}, {266,265,324,390,391,326}, {267,266,325,391,392,327}, {268,267,326,392,393,328}, {269,268,327,393,394,329}, {270,269,328,394,395,330}, {217,270,329,395,396,271}, {332,271,396,331,331,331}, {333,272,271,331,332,332}, {334,273,272,332,333,333}, {335,274,273,333,334,334}, {336,275,274,334,335,335}, {337,276,275,335,336,336}, {338,277,276,336,337,337}, {339,278,277,337,338,338}, {340,279,278,338,339,339}, {341,280,279,339,340,340}, {342,281,280,340,341,341}, {342,343,281,341,342,342}, {343,344,282,281,342,343}, {344,345,283,282,343,344}, {345,346,284,283,344,345}, {346,347,285,284,345,346}, {347,348,286,285,346,347}, {348,349,287,286,347,348}, {349,350,288,287,348,349}, {350,351,289,288,349,350}, {351,352,290,289,350,351}, {352,353,291,290,351,352}, {353,353,354,291,352,353}, {354,354,355,292,291,353}, {355,355,356,293,292,354}, {356,356,357,294,293,355}, {357,357,358,295,294,356}, {358,358,359,296,295,357}, {359,359,360,297,296,358}, {360,360,361,298,297,359}, {361,361,362,299,298,360}, {362,362,363,300,299,361}, {363,363,364,301,300,362}, {364,364,364,365,301,363}, {364,365,365,366,302,301}, {365,366,366,367,303,302}, {366,367,367,368,304,303}, {367,368,368,369,305,304}, {368,369,369,370,306,305}, {369,370,370,371,307,306}, {370,371,371,372,308,307}, {371,372,372,373,309,308}, {372,373,373,374,310,309}, {373,374,374,375,311,310}, {374,375,375,375,376,311}, {311,375,376,376,377,312}, {312,376,377,377,378,313}, {313,377,378,378,379,314}, {314,378,379,379,380,315}, {315,379,380,380,381,316}, {316,380,381,381,382,317}, {317,381,382,382,383,318}, {318,382,383,383,384,319}, {319,383,384,384,385,320}, {320,384,385,385,386,321}, {321,385,386,386,386,387}, {322,321,386,387,387,388}, {323,322,387,388,388,389}, {324,323,388,389,389,390}, {325,324,389,390,390,391}, {326,325,390,391,391,392}, {327,326,391,392,392,393}, {328,327,392,393,393,394}, {329,328,393,394,394,395}, {330,329,394,395,395,396}, {271,330,395,396,396,331} };


ws2811_t ledstring =
{
    .freq = WS2811_TARGET_FREQ,
    .dmanum = 5,
    .channel =
    {
        [0] =
        {
            .gpionum = 18,
            .count = 5,
            .invert = 0,
            .brightness = 255,
        },
        [1] =
        {
            .gpionum = 0,
            .count = 0,
            .invert = 0,
            .brightness = 0,
        },
    },
};

ws2811_led_t color( unsigned char red, unsigned char green, unsigned char blue ) {
  return ( green << 16 ) | ( red << 8 ) | ( blue );
}

ws2811_led_t c = 0x000000;

void render(void) {
  for( int i = 0; i < NLEDS; i++ ) {
      ledstring.channel[0].leds[ i ] = c;
      if( rand() % 10 == 0 ) {
        c = color( rand() % 256, rand() % 256, rand() % 256 );
      }
  }
}

static void ctrl_c_handler(int signum) {
    ws2811_fini(&ledstring);
}

static void setup_handlers(void) {
    struct sigaction sa =
    {
        .sa_handler = ctrl_c_handler,
    };

    sigaction(SIGKILL, &sa, NULL);
}

int main(int argc, char *argv[]) {
    std::cout << "test" << std::endl;
    
    int ret = 0;

    if( board_info_init() < 0 ) {
        return -1;
    }

    setup_handlers();

    if( ws2811_init(&ledstring) ) {
        return -1;
    }

    while (1) {
        render();

        if( ws2811_render(&ledstring) ) {
            ret = -1;
            break;
        }

        // 15 frames /sec
        usleep(500000);
    }

    ws2811_fini(&ledstring);

    return ret;
}
